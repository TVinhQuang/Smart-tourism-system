<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Du lá»‹ch Viá»‡t Nam</title>
    
    <link rel="stylesheet" href="../css/navbar.css">
    <link rel="stylesheet" href="../css/accomodation_card.css">
    <link rel="stylesheet" href="../css/routing.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f9f9f9; }

        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)),
                        url('https://images.unsplash.com/photo-1583417319070-4a69db38a482?w=1200') center/cover;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
        }

        .hero h1 { font-size: 3.5rem; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .hero p { font-size: 1.5rem; margin-bottom: 30px; }

        /* Features Section */
        .features { padding: 60px 20px; max-width: 1200px; margin: 0 auto; }
        .features h2 { text-align: center; font-size: 2.5rem; margin-bottom: 50px; color: #333; }
        
        /* Grid container */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <div id="navbar-root"></div>

    <div class="hero" id="home">
        <div>
            <h1 data-i18n="hero_title">
                Ná»n táº£ng gá»£i Ã½ nÆ¡i lÆ°u trÃº thÃ´ng minh.
            </h1>
            <p data-i18n="hero_desc">
                TÃ¬m khÃ¡ch sáº¡n hoáº·c homestay phÃ¹ há»£p nháº¥t vá»›i nhu cáº§u cá»§a báº¡n.
            </p>
        </div>
    </div>
    
    <div class="features" id="suggestions">
        <h2 data-i18n="section_top_title">Top homestay, khÃ¡ch sáº¡n Ä‘Æ°á»£c gá»£i Ã½</h2>
        
        <div id="accommodation-list" class="feature-grid"></div>
    </div>

    <div id="routing-overlay" class="routing-overlay hidden">
        <div class="routing-modal">     
            <div id="view-step-1" class="view-container">
                <div class="col-left-info">
                    <div class="hotel-cover">
                        <img id="info-img" src="" alt="Hotel Image">
                        <div class="rating-badge">â­ <span id="info-rating">...</span></div>
                    </div>

                    <div class="hotel-info-body">
                        <h2 id="info-name" class="hotel-title">TÃªn khÃ¡ch sáº¡n</h2>
                        
                        <div class="hotel-address-row">
                            <span class="icon">ğŸ“</span> 
                            <span id="info-address">Äá»‹a chá»‰...</span>
                        </div>

                        <div class="hotel-price-row">
                            <span class="label" data-i18n="label_price">GiÃ¡ má»—i Ä‘Ãªm:</span>
                            <span id="info-price" class="price">...</span>
                        </div>

                        <hr class="divider">
                        <div class="hotel-amenities-section">
                            <h4 data-i18n="label_amenities">ğŸ’ Tiá»‡n Ã­ch ná»•i báº­t</h4>
                            <div id="info-amenities" class="amenities">
                                </div>
                        </div>

                        <hr class="divider">

                        <div class="hotel-desc-section">
                            <h4 data-i18n="label_desc">ğŸ“ Giá»›i thiá»‡u</h4>
                            <p id="info-desc">...</p>
                        </div>
                    </div>
                </div>

            <div class="col-right-selection">
                <h3 data-i18n="modal_step1_title">ğŸš™ Thiáº¿t láº­p lá»™ trÃ¬nh</h3>
                
                <div class="form-group">
                    <label data-i18n="input_start_label">Äiá»ƒm xuáº¥t phÃ¡t:</label>
                    <input type="text" data-i18n="val_my_location" value="Vá»‹ trÃ­ cá»§a báº¡n..." disabled class="input-readonly">
                </div>

                <div class="form-group">
                    <label data-i18n="input_dest_label">Äiá»ƒm Ä‘áº¿n:</label>
                    <input type="text" id="target-dest" value="..." disabled class="input-readonly">
                </div>

                <div class="form-group">
                    <label data-i18n="input_transport_label">PhÆ°Æ¡ng tiá»‡n di chuyá»ƒn:</label>
                    <div class="transport-options">
                        <label class="radio-card">
                            <input type="radio" name="transport" value="driving" checked>
                            <span class="icon">ğŸš—</span>
                            <span data-i18n="trans_driving">Ã” tÃ´ / Xe mÃ¡y</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="transport" value="cycling">
                            <span class="icon">ğŸš²</span>
                            <span data-i18n="trans_cycling">Xe Ä‘áº¡p</span>
                        </label>
                        <label class="radio-card">
                            <input type="radio" name="transport" value="foot">
                            <span class="icon">ğŸš¶</span>
                            <span data-i18n="trans_walking">Äi bá»™</span>
                        </label>
                    </div>
                </div>

                <div class="action-buttons">
                    <button id="btn-close-step1" class="btn-secondary" data-i18n="btn_close">ÄÃ³ng</button>
                    <button id="btn-find-route" class="btn-primary" data-i18n="btn_find_route">ğŸ—ºï¸ TÃ¬m Ä‘Æ°á»ng Ä‘i</button>
                </div>
            </div>
        </div>

        <div id="view-step-2" class="view-container hidden">
            <div class="col-left-analysis">
                <button id="btn-back-step1" class="btn-back">â¬… <span data-i18n="btn_back">Quay láº¡i</span></button>
                
                <div class="analysis-box">
                    <h4 data-i18n="analysis_title">ğŸ“Š Káº¿t quáº£ phÃ¢n tÃ­ch</h4>
                    <div class="stats-grid">
                        <div class="stat">ğŸ“ <span id="res-distance">...</span></div>
                        <div class="stat">â± <span id="res-duration">...</span></div>
                    </div>
                    <div class="complexity-box">
                        <strong id="res-label">...</strong>
                        <p id="res-summary">...</p>
                        <ul id="res-details"></ul>
                    </div>
                    <div class="advice-box">
                        ğŸ’¡ <span id="res-advice">...</span>
                    </div>
                </div>

                <div class="steps-box">
                    <h4 data-i18n="steps_title">ğŸ“ HÆ°á»›ng dáº«n chi tiáº¿t</h4>
                    <div id="steps-list" class="steps-scroll">
                        </div>
                </div>
            </div>

            <div class="col-right-map">
                <div id="rt-map-frame"></div>
                <div class="map-controls-overlay">
                    <select id="quick-transport-change">
                        <option value="driving" data-i18n="trans_driving">ğŸš— Ã” tÃ´</option>
                        <option value="cycling" data-i18n="trans_cycling">ğŸš² Xe Ä‘áº¡p</option>
                        <option value="foot" data-i18n="trans_walking">ğŸš¶ Äi bá»™</option>
                    </select>
                </div>
            </div>
        </div>

    </div>
</div>
    <script>
        // Load navbar component
        (function(){
            fetch('../components/navbar.html')
                .then(function(r){ return r.text(); })
                .then(function(html){ document.getElementById('navbar-root').innerHTML = html; })
                .catch(function(){ console.warn('KhÃ´ng thá»ƒ load navbar component'); });
        })();
    
    </script>

    <script src="../js/static_trans.js"></script>
    <script src="../js/rec_accomodation.js"></script>
    <script src="../js/homepage.js"></script>
    <script src="../js/routing.js"></script>
    <script src="../js/display_results.js"></script>

    <script>
// --- 1. LOGIC DUY TRÃŒ TRáº NG THÃI ÄÄ‚NG NHáº¬P (DÃ¹ng LOCALSTORAGE) ---

function logoutUser() {
    // XÃ³a email khá»i bá»™ nhá»› cá»¥c bá»™
    localStorage.removeItem('loggedInUserEmail');
    // Chuyá»ƒn hÆ°á»›ng vá» trang login
    window.location.href = 'login.html'; 
}

function formatEmail(email) {
    if (!email) return "NgÆ°á»i dÃ¹ng";
    const parts = email.split('@');
    return parts[0]; 
}

function updateNavbarForLoggedInUser() {
    // Äá»ŒC EMAIL Tá»ª LOCAL STORAGE
    const userEmail = localStorage.getItem('loggedInUserEmail'); 
    const navbarRoot = document.getElementById('navbar-root');
    
    // Äáº£m báº£o navbar component Ä‘Ã£ táº£i xong
    if (navbarRoot.innerHTML !== "") {
        const loginButtonContainer = navbarRoot.querySelector('.nav-right'); 

        if (userEmail) {
            const displayName = formatEmail(userEmail);
            if (loginButtonContainer) {
                // Thay tháº¿ nÃºt "ÄÄƒng nháº­p" báº±ng TÃªn ngÆ°á»i dÃ¹ng vÃ  nÃºt ÄÄƒng xuáº¥t
                loginButtonContainer.innerHTML = `
                    <div class="user-info-group">
                        <span class="user-greeting">ğŸ‘‹ <span data-i18n="nav_greeting">Xin chÃ o,</span> <strong>${displayName}</strong></span>
                        <button class="btn-logout" onclick="logoutUser()">
                            <img src="../../images/logout.png" class="logout-icon" style="height: 16px;">
                            <span data-i18n="nav_logout">ÄÄƒng xuáº¥t</span>
                        </button>
                    </div>
                `;
            }
        } else {
            // Náº¿u chÆ°a Ä‘Äƒng nháº­p, hiá»ƒn thá»‹ nÃºt ÄÄƒng nháº­p
            if (loginButtonContainer) {
            loginButtonContainer.innerHTML = `
             <a href="login.html" class="btn-login">
                 <img src="../../images/login.png" class="login-icon">
                 <span data-i18n="nav_login">ÄÄƒng nháº­p</span>
             </a>
                `;
            }
        }
        // Ãp dá»¥ng dá»‹ch thuáº­t cho cÃ¡c pháº§n tá»­ vá»«a Ä‘Æ°á»£c chÃ¨n
        applyTranslations();
    } else {
         // Náº¿u Navbar chÆ°a load xong, thá»­ láº¡i sau 100ms
         setTimeout(updateNavbarForLoggedInUser, 100);
    }
}

// --- 2. LOGIC Dá»ŠCH THUáº¬T VÃ€ TOGGLE DROPWDOWN ---

let currentTranslations = {};

function getTranslation(key) {
    return currentTranslations[key] || key;
}

function applyTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = getTranslation(key);
        
        if (element.tagName === 'BUTTON' || element.tagName === 'A') {
            if (element.lastChild && element.lastChild.nodeType === 3) {
                element.lastChild.textContent = translation;
            } else {
                element.textContent = translation;
            }
        } else {
            element.textContent = translation;
        }
    });
}

async function loadAndApplyLanguage(lang) {
    const filePath = `../i18n/${lang}.json`;
    
    try {
        const response = await fetch(filePath);
        if (!response.ok) { throw new Error(`KhÃ´ng thá»ƒ táº£i file dá»‹ch thuáº­t: ${filePath}`); }
        currentTranslations = await response.json();
        localStorage.setItem('lang', lang); 

        applyTranslations();
        
        // â­ LÆ¯U Ã: KhÃ´ng gá»i updateNavbarForLoggedInUser á»Ÿ Ä‘Ã¢y, 
        // vÃ¬ nÃ³ sáº½ Ä‘Æ°á»£c gá»i sau khi Navbar component Ä‘Ã£ load.
        // Logic Ä‘Ã³ náº±m á»Ÿ khá»‘i khá»Ÿi táº¡o dÆ°á»›i Ä‘Ã¢y.

    } catch (error) {
        console.error("Lá»—i Dá»‹ch thuáº­t:", error);
    }
}

function changeLanguage(lang) {
    loadAndApplyLanguage(lang);
    const menu = document.getElementById('languageMenu');
    if (menu) {
        menu.classList.add('hidden');
        document.removeEventListener('click', closeMenuOutside);
    }
    return false;
}

function toggleLanguageMenu() {
    const menu = document.getElementById('languageMenu');
    if (menu) {
        menu.classList.toggle('hidden'); 
        if (!menu.classList.contains('hidden')) {
            document.addEventListener('click', closeMenuOutside);
        } else {
            document.removeEventListener('click', closeMenuOutside);
        }
    }
}

function closeMenuOutside(event) {
    const dropdown = document.querySelector('.dropdown');
    const menu = document.getElementById('languageMenu');

    if (dropdown && menu && !dropdown.contains(event.target)) {
        menu.classList.add('hidden');
        document.removeEventListener('click', closeMenuOutside);
    }
}

// --- 3. KHá»I Táº O CHUNG (Táº¢I NAVBAR VÃ€ Cáº¬P NHáº¬T TRáº NG THÃI) ---

document.addEventListener('DOMContentLoaded', () => {
    // 1. Load Navbar
    fetch('../components/navbar.html')
        .then(r => r.text())
        .then(html => { 
            document.getElementById('navbar-root').innerHTML = html; 
            
            // 2. Táº£i ngÃ´n ngá»¯
            const defaultLang = localStorage.getItem('lang') || 'vi'; 
            loadAndApplyLanguage(defaultLang)
                .then(() => {
                    // 3. Cáº­p nháº­t tráº¡ng thÃ¡i Ä‘Äƒng nháº­p sau khi load ngÃ´n ngá»¯ vÃ  Navbar thÃ nh cÃ´ng
                    updateNavbarForLoggedInUser();
                });
        })
        .catch(e => console.warn('KhÃ´ng thá»ƒ load navbar component', e));
});
</script>
</body>

</html>