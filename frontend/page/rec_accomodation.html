<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="nav_suggest">G·ª£i √Ω N∆°i ·ªû</title>

    <link rel="stylesheet" href="../css/rec_accomodation.css">
    <link rel="stylesheet" href="../css/navbar.css">
</head>

<body>
    
    <div id="navbar-root"></div>

    <h1 class="page-title" data-i18n="rec_title">üè® G·ª£i √Ω N∆°i ·ªû Ph√π H·ª£p</h1>
    <h2 class="page-subtitle" data-i18n="rec_subtitle">ƒêi·ªÅn th√¥ng tin d∆∞·ªõi ƒë√¢y ƒë·ªÉ nh·∫≠n g·ª£i √Ω n∆°i l∆∞u tr√∫ t·ªët nh·∫•t cho chuy·∫øn ƒëi c·ªßa b·∫°n!</h2>
    <div class="form-section">

        <div class="form-group">
            <label data-i18n="input_city">Th√†nh ph·ªë</label>
            <input type="string" id="city" value="ƒê√† N·∫µng">
        </div>

        <div class="form-group">
            <label data-i18n="input_group_size">S·ªë ng∆∞·ªùi</label>
            <input type="number" id="group-size" value="2">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label data-i18n="input_price_min">Gi√° t·ª´</label>
                <input type="number" id="price-min" value="300000" step="50000">
            </div>

            <div class="form-group">
                <label data-i18n="input_price_max">Gi√° ƒë·∫øn</label>
                <input type="number" id="price-max" value="1500000" step="50000">
            </div>
        </div>

        <div class="form-group">
            <label data-i18n="input_type">Lo·∫°i h√¨nh</label>
            <div class="checkbox-group">
                <label><input type="checkbox" class="type-checkbox" value="hotel" checked> <span data-i18n="type_hotel">Hotel</span></label>
                <label><input type="checkbox" class="type-checkbox" value="homestay" checked> <span data-i18n="type_homestay">Homestay</span></label>
                <label><input type="checkbox" class="type-checkbox" value="hostel"> <span data-i18n="type_hostel">Hostel</span></label>
                <label><input type="checkbox" class="type-checkbox" value="apartment"> <span data-i18n="type_apartment">Apartment</span></label>
            </div>
        </div>

        <div class="form-group">
            <label data-i18n="input_params">Th√¥ng s·ªë t√¨m ki·∫øm</label>

            <div class="filter-row">
                <div class="filter-item">
                    <label for="min-rating" data-i18n="input_min_rating">ƒê√°nh gi√° t·ªëi thi·ªÉu</label>
                    <div class="slider-wrap">
                        <input 
                            type="range" 
                            id="min-rating" 
                            min="0" 
                            max="10" 
                            step="0.5" 
                            value="3"
                            oninput="minRatingValue.textContent = this.value">
                        <span id="minRatingValue">3</span>
                    </div>
                </div>

                <div class="filter-item">
                    <label for="radius" data-i18n="input_radius">B√°n k√≠nh t√¨m ki·∫øm (km)</label>
                    <div class="slider-wrap">
                        <input 
                            type="range" 
                            id="radius" 
                            min="1" 
                            max="20" 
                            step="1" 
                            value="5"
                            oninput="radiusValue.textContent = this.value + ' km'">
                        <span id="radiusValue">5</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group">
                <label data-i18n="input_amenity_required">Ti·ªán √≠ch B·∫ÆT BU·ªòC</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" class="amenity-required" value="wifi" checked> <span data-i18n="amenity_wifi">WiFi</span></label>
                    <label><input type="checkbox" class="amenity-required" value="breakfast"> <span data-i18n="amenity_breakfast">Breakfast</span></label>
                    <label><input type="checkbox" class="amenity-required" value="pool"> <span data-i18n="amenity_pool">Pool</span></label>
                    <label><input type="checkbox" class="amenity-required" value="parking"> <span data-i18n="amenity_parking">Parking</span></label>
                </div>
            </div>

            <div class="form-group">
                <label data-i18n="input_amenity_preferred">Ti·ªán √≠ch ∆ØU TI√äN</label>
                <div class="checkbox-group">
                    <label><input type="checkbox" class="amenity-preferred" value="wifi"> <span data-i18n="amenity_wifi">WiFi</span></label>
                    <label><input type="checkbox" class="amenity-preferred" value="breakfast" checked> <span data-i18n="amenity_breakfast">Breakfast</span></label>
                    <label><input type="checkbox" class="amenity-preferred" value="pool"> <span data-i18n="amenity_pool">Pool</span></label>
                    <label><input type="checkbox" class="amenity-preferred" value="parking"> <span data-i18n="amenity_parking">Parking</span></label>
                </div>
            </div>

            <div class="form-group">
                <label for="priority" data-i18n="input_priority">∆Øu ti√™n x·∫øp h·∫°ng</label>
                <select id="priority">
                    <option value="balanced" data-i18n="prio_balanced">C√¢n b·∫±ng (gi√°, rating, ti·ªán √≠ch, kho·∫£ng c√°ch)</option>
                    <option value="cheap" data-i18n="prio_cheap">∆Øu ti√™n gi√° r·∫ª</option>
                    <option value="near_center" data-i18n="prio_near_center">∆Øu ti√™n g·∫ßn trung t√¢m</option>
                    <option value="amenities" data-i18n="prio_amenities">∆Øu ti√™n ti·ªán √≠ch</option>
                </select>
            </div>
     <button class="submit-btn" onclick="submitSearch()" data-i18n="btn_suggest_top5">üîç G·ª£i √Ω Top 5 n∆°i ·ªü</button>
    <div id="results-container">
        <h2 data-i18n="rec_results">K·∫øt qu·∫£</h2>
        <div id="results-list"></div>
    
    <div id="map-popup" style="display:none;">
        <div id="map" style="height:300px; margin-bottom: 10px;"></div>
        <div id="main-route" style="font-weight:bold; margin-bottom:10px;"></div>
        <button id="toggle-details">+ Xem ƒë∆∞·ªùng ƒëi chi ti·∫øt</button>
        <ul id="detail-steps" style="display:none; margin-top:10px;"></ul>
    </div>

    </div>

    <script src="../js/navbar_loader.js"></script>
    <script src="../js/display_results.js"></script>
    <script src="../js/rec_accomodation.js"></script>
    
    <script>
    // --- 1. LOGIC DUY TR√å TR·∫†NG TH√ÅI ƒêƒÇNG NH·∫¨P (D√πng LOCALSTORAGE) ---

    function logoutUser() {
        localStorage.removeItem('loggedInUserEmail');
        window.location.href = 'login.html'; 
    }

    function formatEmail(email) {
        if (!email) return "Ng∆∞·ªùi d√πng";
        const parts = email.split('@');
        return parts[0]; 
    }

    function updateNavbarForLoggedInUser() {
        const userEmail = localStorage.getItem('loggedInUserEmail'); 
        const navbarRoot = document.getElementById('navbar-root');
        
        if (navbarRoot.innerHTML !== "") {
            const loginButtonContainer = navbarRoot.querySelector('.nav-right'); 

            if (userEmail) {
                const displayName = formatEmail(userEmail);
                if (loginButtonContainer) {
                    loginButtonContainer.innerHTML = `
                        <div class="user-info-group">
                            <span class="user-greeting">üëã <span data-i18n="nav_greeting">Xin ch√†o,</span> <strong>${displayName}</strong></span>
                            <button class="btn-logout" onclick="logoutUser()">
                                <img src="../../images/logout.png" class="logout-icon" style="height: 16px;">
                                <span data-i18n="nav_logout">ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    `;
                }
            } else {
                if (loginButtonContainer) {
                loginButtonContainer.innerHTML = `
                <a href="login.html" class="btn-login">
                 <img src="../../images/login.png" class="login-icon">
                 <span data-i18n="nav_login">ƒêƒÉng nh·∫≠p</span>
                </a>
                   `;
                }
            }
            applyTranslations();
        } else {
             setTimeout(updateNavbarForLoggedInUser, 100);
        }
    }

    // --- 2. LOGIC D·ªäCH THU·∫¨T V√Ä TOGGLE DROPWDOWN ---

    let currentTranslations = {};

    function getTranslation(key) {
        return currentTranslations[key] || key;
    }

    function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            const translation = getTranslation(key);
            
            if (element.tagName === 'BUTTON' || element.tagName === 'A') {
                if (element.lastChild && element.lastChild.nodeType === 3) {
                    element.lastChild.textContent = translation;
                } else {
                    element.textContent = translation;
                }
            } else {
                element.textContent = translation;
            }
        });
    }

    async function loadAndApplyLanguage(lang) {
        const filePath = `../i18n/${lang}.json`;
        
        try {
            const response = await fetch(filePath);
            if (!response.ok) { throw new Error(`Kh√¥ng th·ªÉ t·∫£i file d·ªãch thu·∫≠t: ${filePath}`); }
            currentTranslations = await response.json();
            localStorage.setItem('lang', lang); 

            applyTranslations();

        } catch (error) {
            console.error("L·ªói D·ªãch thu·∫≠t:", error);
        }
    }

    function changeLanguage(lang) {
        loadAndApplyLanguage(lang);
        const menu = document.getElementById('languageMenu');
        if (menu) {
            menu.classList.add('hidden');
            document.removeEventListener('click', closeMenuOutside);
        }
        return false;
    }

    function toggleLanguageMenu() {
        const menu = document.getElementById('languageMenu');
        if (menu) {
            menu.classList.toggle('hidden'); 
            if (!menu.classList.contains('hidden')) {
                document.addEventListener('click', closeMenuOutside);
            } else {
                document.removeEventListener('click', closeMenuOutside);
            }
        }
    }

    function closeMenuOutside(event) {
        const dropdown = document.querySelector('.dropdown');
        const menu = document.getElementById('languageMenu');

        if (dropdown && menu && !dropdown.contains(event.target)) {
            menu.classList.add('hidden');
            document.removeEventListener('click', closeMenuOutside);
        }
    }

    // --- 3. KH·ªûI T·∫†O CHUNG (T·∫¢I NAVBAR V√Ä C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI) ---

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Load Navbar
        fetch('../components/navbar.html')
            .then(r => r.text())
            .then(html => { 
                document.getElementById('navbar-root').innerHTML = html; 
                
                // 2. T·∫£i ng√¥n ng·ªØ
                const defaultLang = localStorage.getItem('lang') || 'vi'; 
                loadAndApplyLanguage(defaultLang)
                    .then(() => {
                        // 3. C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒëƒÉng nh·∫≠p sau khi load ng√¥n ng·ªØ v√† Navbar th√†nh c√¥ng
                        updateNavbarForLoggedInUser();
                    });
            })
            .catch(e => console.warn('Kh√¥ng th·ªÉ load navbar component', e));
    });
    </script>

</body>

<div id="routeBox" style="display:none; margin-top:20px;">
    <h3>üìç L·ªô tr√¨nh di chuy·ªÉn</h3>

    <img id="routeMap" src="" style="width:100%; border-radius:10px; margin-bottom:15px;">

    <p><b>Qu√£ng ƒë∆∞·ªùng:</b> <span id="kmText"></span></p>
    <p><b>Th·ªùi gian d·ª± ki·∫øn:</b> <span id="timeText"></span></p>

    <h4>üöó ƒê∆∞·ªùng ƒëi ch√≠nh</h4>
    <ul id="mainStepsList"></ul>

    <button id="toggleDetailBtn" onclick="toggleDetailSteps()">+ ƒê∆∞·ªùng ƒëi c·ª• th·ªÉ</button>

    <ul id="detailStepsList" style="display:none; margin-top:10px;"></ul>
</div>

</html>