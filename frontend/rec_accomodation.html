<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G·ª£i √Ω N∆°i ·ªû</title>

    <link rel="stylesheet" href="css/rec_accomodation.css">
    <link rel="stylesheet" href="css/navbar.css">
    <link rel="stylesheet" href="css/routing.css">
    <link rel="stylesheet" href="css/chatbot.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>

<body>
    <div id="navbar-root"></div>

    <h1 class="page-title" data-i18n="page_title_rec">üè® G·ª£i √ù N∆°i ·ªû Ph√π H·ª£p</h1>
    <h2 class="page-subtitle" data-i18n="page_subtitle_rec">ƒêi·ªÅn th√¥ng tin d∆∞·ªõi ƒë√¢y ƒë·ªÉ nh·∫≠n g·ª£i √Ω n∆°i l∆∞u tr√∫ t·ªët nh·∫•t cho chuy·∫øn ƒëi c·ªßa b·∫°n!</h2>
    
    <div class="form-section">

        <div class="form-group">
            <label data-i18n="label_city">Th√†nh ph·ªë ƒêi·ªÉm ƒë·∫øn</label>
            <input type="text" id="city" value="H·ªì Ch√≠ Minh" placeholder="Nh·∫≠p t√™n th√†nh ph·ªë...">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label data-i18n="label_price_from1">Gi√° t·ª´ (VND)</label>
                <input type="number" id="price-min" value="300000" step="50000">
            </div>

            <div class="form-group">
                <label data-i18n="label_price_to1">Gi√° ƒë·∫øn (VND)</label>
                <input type="number" id="price-max" value="1500000" step="50000">
            </div>
        </div>

        <div class="form-group">
            <label data-i18n="label_type">Lo·∫°i h√¨nh</label>
            <div class="checkbox-group">
                <label><input type="checkbox" class="type-checkbox" value="hotel" checked> Hotel</label>
                <label><input type="checkbox" class="type-checkbox" value="homestay" checked> Homestay</label>
                <label><input type="checkbox" class="type-checkbox" value="hostel"> Hostel</label>
                <label><input type="checkbox" class="type-checkbox" value="apartment"> Apartment</label>
                <label><input type="checkbox" class="type-checkbox" value="resort"> Resort</label>
            </div>
        </div>

        <div class="form-group">
            <label data-i18n="label_search_params">B·ªô l·ªçc n√¢ng cao</label>
            
            <div class="filter-row" style="margin-top: 15px;">
    
    <div class="filter-item">
        <label data-i18n="label_min_rating">ƒê√°nh gi√° t·ªëi thi·ªÉu</label>
        <div class="checkbox-group-vertical">
            <label>
                <input type="radio" name="min_rating" value="3" checked> 
                T·ª´ 3 sao tr·ªü l√™n
            </label>
            <label>
                <input type="radio" name="min_rating" value="4"> 
                T·ª´ 4 sao tr·ªü l√™n
            </label>
            <label>
                <input type="radio" name="min_rating" value="5"> 
                5 sao
            </label>
        </div>
    </div>

        <div class="filter-item">
            <label data-i18n="label_radius">Kho·∫£ng c√°ch t·ª´ trung t√¢m</label>
            <div class="checkbox-group-vertical">
                <label>
                    <input type="radio" name="radius" value="1"> 
                    D∆∞·ªõi 1 km
                </label>
                <label>
                    <input type="radio" name="radius" value="3"> 
                    D∆∞·ªõi 3 km
                </label>
                <label>
                    <input type="radio" name="radius" value="5" checked> 
                    D∆∞·ªõi 5 km
                </label>
            </div>
        </div>
    </div>

        <div class="form-group">
            <label data-i18n="label_amenity_pref">Ti·ªán √≠ch ∆ØU TI√äN</label>
            <div class="checkbox-group">
                <label><input type="checkbox" class="amenity-preferred" value="wifi"> WiFi</label>
                <label><input type="checkbox" class="amenity-preferred" value="breakfast" checked> Breakfast</label>
                <label><input type="checkbox" class="amenity-preferred" value="pool"> Pool</label>
                <label><input type="checkbox" class="amenity-preferred" value="parking"> Parking</label>
                <label><input type="checkbox" class="amenity-preferred" value="gym"> Gym</label>
                <label><input type="checkbox" class="amenity-preferred" value="spa"> Spa</label>
                <label><input type="checkbox" class="amenity-preferred" value="airport_shuttle"> Airport Shuttle</label>
            </div>
        </div>

        <div class="form-group">
            <label for="priority" data-i18n="label_priority">Chi·∫øn l∆∞·ª£c x·∫øp h·∫°ng</label>
            <select id="priority">
                <option value="balanced" data-i18n="opt_balanced">C√¢n b·∫±ng (Khuy√™n d√πng)</option>
                <option value="cheap" data-i18n="opt_cheap">∆Øu ti√™n gi√° r·∫ª</option>
                <option value="near_center" data-i18n="opt_center">∆Øu ti√™n g·∫ßn trung t√¢m</option>
                <option value="amenities" data-i18n="opt_amenities">∆Øu ti√™n ti·ªán √≠ch</option>
            </select>
        </div>

        <button type="button" class="submit-btn" onclick="submitSearch()" data-i18n="btn_search_rec">üîç G·ª£i √Ω Top 5 n∆°i ·ªü</button>

        <div id="results-container">
            <h2 data-i18n="header_results">K·∫øt qu·∫£</h2>
            <div id="relaxation-note" style="display:none; background:#fff3cd; color:#856404; padding:10px; border-radius:5px; margin-bottom:15px; border:1px solid #ffeeba;"></div>
            <div id="results-list"></div>
        </div>
    </div>

    <div id="routing-overlay" class="routing-overlay hidden">
       <div class="routing-modal">     
            <div id="view-step-1" class="view-container">
                <div class="col-left-info">
                    <div class="hotel-cover">
                        <div class="rating-badge">‚≠ê <span id="info-rating">...</span></div>
                    </div>
                    <div class="hotel-info-body">
                        <h2 id="info-name" class="hotel-title">T√™n kh√°ch s·∫°n</h2>
                        <div class="favorite-row"><span id="fav-toggle" class="fav-btn">‚ô°</span></div>
                        <div class="hotel-address-row"><span class="icon">üìç</span> <span id="info-address">...</span></div>
                        <div class="hotel-price-row"><span class="label">Gi√° m·ªói ƒë√™m:</span><span id="info-price" class="price">...</span></div>
                        <hr class="divider">
                        <div class="hotel-amenities-section"><h4>üíé Ti·ªán √≠ch</h4><div id="info-amenities" class="amenities"></div></div>
                    </div>
                </div>
                <div class="col-right-selection">
                    <h3>üöô Thi·∫øt l·∫≠p l·ªô tr√¨nh</h3>
                    <div class="form-group"><label>ƒêi·ªÉm xu·∫•t ph√°t:</label><div style="display:flex;gap:5px;"><input type="text" id="start-location" class="input-editable" style="flex:1;"><button id="btn-use-gps">üìç</button></div></div>
                    <div class="form-group"><label>ƒêi·ªÉm ƒë·∫øn:</label><input type="text" id="target-dest" disabled class="input-readonly"></div>
                    <div class="form-group"><label>Ph∆∞∆°ng ti·ªán:</label><div class="transport-options">
                        <label class="radio-card"><input type="radio" name="transport" value="driving" checked><span>üöó √î t√¥</span></label>
                        <label class="radio-card"><input type="radio" name="transport" value="cycling"><span>üö≤ Xe ƒë·∫°p</span></label>
                        <label class="radio-card"><input type="radio" name="transport" value="walking"><span>üö∂ ƒêi b·ªô</span></label>
                    </div></div>
                    <div class="action-buttons"><button id="btn-close-step1" class="btn-secondary">ƒê√≥ng</button><button id="btn-find-route" class="btn-primary">üó∫Ô∏è T√¨m ƒë∆∞·ªùng ƒëi</button></div>
                </div>
            </div>
            <div id="view-step-2" class="view-container hidden" style="height: 80vh;">
                <div class="col-left-analysis" style="overflow-y: auto; height: 100%;">
                    <button id="btn-back-step1" class="btn-back">‚¨Ö Quay l·∫°i</button>
                    <div class="analysis-box">
                        <h4>üìä K·∫øt qu·∫£ ph√¢n t√≠ch</h4>
                        <div class="stats-grid"><div class="stat">Kho·∫£ng c√°ch: <span id="res-distance">...</span></div><div class="stat">Th·ªùi gian: <span id="res-duration">...</span></div></div>
                        <div class="complexity-box">
                            <strong id="res-label">...</strong>
                            <p id="res-summary">...</p>
                            
                            <p id="res-advice" style="font-style: italic; color: #555; font-size: 0.9rem; margin-top: 5px;">...</p>
                            
                            <ul id="res-details"></ul>
                        </div>
                    </div>
                    <div class="steps-box"><h4>üìù H∆∞·ªõng d·∫´n</h4><div id="steps-list" class="steps-scroll"></div></div>
                </div> 
               <div class="col-right-map" style="position: relative; height: 100%;">
                    <div style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
                        <select id="quick-transport-change" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-weight: bold; cursor: pointer; outline: none;">
                            <option value="driving">üöó √î t√¥ / Xe m√°y</option>
                            <option value="cycling">üö≤ Xe ƒë·∫°p</option>
                            <option value="walking">üö∂ ƒêi b·ªô</option>
                        </select>
                    </div>
                    <div id="rt-map" style="width: 100%; height: 100%; z-index: 0;"></div>
</div></div>
            </div>
        </div>
    </div>

    <script>
        // 1. Logic x·ª≠ l√Ω user ƒëƒÉng nh·∫≠p
        function logoutUser() {
            localStorage.removeItem('loggedInUserEmail');
            location.reload(); 
        }

        function formatEmail(email) {
            if (!email) return "Ng∆∞·ªùi d√πng";
            return email.split('@')[0]; 
        }

        function updateNavbarForLoggedInUser() {
            const userEmail = localStorage.getItem('loggedInUserEmail'); 
            const navbarRoot = document.getElementById('navbar-root');
            
            // Ch·ªâ ch·∫°y khi navbar ƒë√£ c√≥ n·ªôi dung
            if (navbarRoot && navbarRoot.innerHTML.trim() !== "") {
                const loginButtonContainer = navbarRoot.querySelector('.nav-right'); 
                if (userEmail && loginButtonContainer) {
                    const displayName = formatEmail(userEmail);
                    loginButtonContainer.innerHTML = `
                        <div class="user-info-group">
                            <span class="user-greeting">üëã <span data-i18n="nav_greeting">Xin ch√†o,</span> <strong>${displayName}</strong></span>
                            <button class="btn-logout" onclick="logoutUser()">
                                <img src="images/logout.png" class="logout-icon" style="height: 16px;">
                                <span data-i18n="nav_logout">ƒêƒÉng xu·∫•t</span>
                            </button>
                        </div>
                    `;
                }
            }
        }

        // 2. Ch·∫°y khi trang load xong
        document.addEventListener('DOMContentLoaded', () => {
            
            // Load Navbar t·ª´ components/navbar.html (ƒê∆∞·ªùng d·∫´n ƒë√∫ng)
            fetch('components/navbar.html')
                .then(response => {
                    if (!response.ok) throw new Error("L·ªói t·∫£i Navbar: " + response.status);
                    return response.text();
                })
                .then(html => { 
                    // Ki·ªÉm tra xem server c√≥ tr·∫£ v·ªÅ l·ªói 404 text kh√¥ng
                    if (html.includes("Cannot GET") || html.startsWith("<!DOCTYPE")) {
                        console.error("N·ªôi dung Navbar kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng HTML");
                        return;
                    }

                    document.getElementById('navbar-root').innerHTML = html; 
                    
                    // C·∫≠p nh·∫≠t giao di·ªán ng∆∞·ªùi d√πng
                    updateNavbarForLoggedInUser();

                    // K√≠ch ho·∫°t d·ªãch thu·∫≠t sau khi Navbar ƒë√£ ch√®n v√†o DOM
                    const currentLang = localStorage.getItem('lang') || 'vi';
                    // Ki·ªÉm tra h√†m loadLanguage t·ª´ file static_trans.js
                    if (typeof loadLanguage === 'function') {
                        loadLanguage(currentLang);
                    } else if (typeof loadAndApplyLanguage === 'function') {
                        loadAndApplyLanguage(currentLang);
                    }
                })
                .catch(e => console.error('L·ªói script navbar:', e));
        });
    </script>
    
    <script src="js/navbar_loader.js"></script>
    <script src="js/chatbot.js"></script>
    <script src="js/static_trans.js"></script>
    <script src="js/display_result_rec.js"></script> 
    <script src="js/routing_rec_page.js"></script>
    <script src="js/submit_search.js"></script>
</body>
</html>